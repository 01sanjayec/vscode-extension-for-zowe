# Workflow name for GitHub Actions
name: Theia Zowe Explorer CI

on: [push]


##### NEED TO DOWNLOAD BEFORE SECOND JOB RUNS

# Variables for all jobs
env:
  PACKAGING_DIRECTORY: temp
  PACKAGE_NAME: vscode-extension-for-zowe.vsix

jobs:


  build:

    runs-on: ubuntu-latest

    steps:
      # check out source
      - uses: actions/checkout@v2

      # install dependencies
      #   equivalent to `npm ci`
      #   - run: yarn install --frozen-lockfile
      - run: npm ci

      # copy test data file needed for build :-(
      - name: Create test data file
        run: cp resources/testProfileData.example.ts resources/testProfileData.ts

      - run: yarn build

      - name: Create extension install directory
        run: mkdir -p temp/plugins && chmod -R 777 temp

      - name: Build vsix
        run: yarn vsce package -o temp/plugins/vscode-extension-for-zowe.vsix

      - run: docker run --init -d -p 3000:3000 -v "temp:/home/theia/.theia" theiaide/theia:next
      # services:
      #   theia:
      #     image: theiaide/theia:next
      #     ports:
      #       - 3000:3000
      #     volumes:
      #       - temp:/home/theia/.theia
      #     # --health-cmd "curl --fail http://localhost:3000 || exit 1" --health-interval=5s --health-timeout=5s --health-retries 60 
      #     options: --init

      - run: yarn lint

      - name: Upload vsix
        uses: actions/upload-artifact@v1
        with:
          name: vscode-extension-for-zowe.vsix
          path: temp/plugins/vscode-extension-for-zowe.vsix

      - name: Verify Theia accessible
        run: curl --fail http://localhost:3000

      - run: yarn test:theia

